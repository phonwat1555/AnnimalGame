import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Sparkles, Trophy, RotateCcw, Volume2, VolumeX, Music, Music2 } from 'lucide-react';

// --- Configuration & Data ---

// ‡πÉ‡∏ä‡πâ Base64 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SFX ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
const SOUNDS = {
  // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏õ‡∏¥‡πä‡∏á! (‡∏ñ‡∏π‡∏Å)
  correct: "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbqWEzM2Sfv8zDyGFAREZwn8fKw21KSEhun8fKw21KSEhun8fKw21KSEhun8fKw21KSEhugIqF", 
  // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏∑‡πä‡∏î! (‡∏ú‡∏¥‡∏î)
  wrong: "data:audio/wav;base64,UklGRiIGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQYGAACam5uCg4KJjI2WlZSSkI+Qj4+RkpGSkI+Qj4+RkpGSkI+Qj4+RkpGSkI+Qj4+RkpGSkI+Qj4+RkpGSkI+Qj4+RkpGSkI+Qj4+RkpCT",
  // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ß‡∏¥‡πâ‡∏á‡πÜ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°)
  start: "data:audio/wav;base64,UklGRjIGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YRIQAACAgYKEhYaHiImKi4yNjo+QkZKTlJWWl5iZmpucnZ6foKGio6SlpqeoqaqrrK2ur7CxsrO0tba3uLm6u7y9vr/AwcLDxMXGx8jJysvMzc7P0NHS09TV1tfY2drb3N3e3+Dh4uPk5ebn6Onq6+zt7u/w8fLz9PX29/j5+vv8/f7/AA==",
  // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏ö‡∏°‡∏∑‡∏≠/‡∏ä‡∏ô‡∏∞ (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡∏±‡∏ß)
  win: "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbqWEzM2Sfv8zDyGFAREZwn8fKw21KSEhun8fKw21KSEhun8fKw21KSEhun8fKw21KSEhugIqF"
};

const CATEGORIES = [
  { id: 'water', name: '‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ô‡πâ‡∏≥', color: 'bg-gradient-to-br from-blue-300 to-blue-400', borderColor: 'border-blue-500', textColor: 'text-blue-900', icon: 'üêü' },
  { id: 'land', name: '‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ö‡∏Å', color: 'bg-gradient-to-br from-green-300 to-green-400', borderColor: 'border-green-500', textColor: 'text-green-900', icon: 'üêò' },
  { id: 'reptile', name: '‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏∑‡πâ‡∏≠‡∏¢‡∏Ñ‡∏•‡∏≤‡∏ô', color: 'bg-gradient-to-br from-orange-300 to-orange-400', borderColor: 'border-orange-500', textColor: 'text-orange-900', icon: 'ü¶é' },
  { id: 'winged', name: '‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡∏µ‡∏Å', color: 'bg-gradient-to-br from-pink-300 to-pink-400', borderColor: 'border-pink-500', textColor: 'text-pink-900', icon: 'ü¶ã' },
];

const ANIMALS_DATA = [
  // ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ô‡πâ‡∏≥
  { id: 'w1', name: '‡∏õ‡∏π', category: 'water', src: 'https://img2.pic.in.th/pic/5d7beae4ee6af6747.png' },
  { id: 'w2', name: '‡∏´‡∏≠‡∏¢', category: 'water', src: 'https://img5.pic.in.th/file/secure-sv1/3bc573c9bb833512a.png' },
  { id: 'w3', name: '‡∏õ‡∏•‡∏≤', category: 'water', src: 'https://img2.pic.in.th/pic/2215b8e7aff998e18.png' },
  { id: 'w4', name: '‡∏Å‡∏∏‡πâ‡∏á', category: 'water', src: 'https://img2.pic.in.th/pic/40aafd240477916f7.png' },
  // ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ö‡∏Å
  { id: 'l1', name: '‡∏ä‡πâ‡∏≤‡∏á', category: 'land', src: 'https://img5.pic.in.th/file/secure-sv1/121c740a3a6afb93f1.png' },
  { id: 'l2', name: '‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢', category: 'land', src: 'https://img5.pic.in.th/file/secure-sv1/13215b8ff2c0dbceba.png' },
  { id: 'l3', name: '‡πÅ‡∏°‡∏ß', category: 'land', src: 'https://img2.pic.in.th/pic/143c965a970965c27c.png' },
  { id: 'l4', name: '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç', category: 'land', src: 'https://img5.pic.in.th/file/secure-sv1/15788d8bd3ba727e5b.png' },
  // ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏∑‡πâ‡∏≠‡∏¢‡∏Ñ‡∏•‡∏≤‡∏ô
  { id: 'r1', name: '‡∏á‡∏π', category: 'reptile', src: 'https://img2.pic.in.th/pic/snapedit_1764731201634-Photoroom.png' },
  { id: 'r2', name: '‡πÄ‡∏ï‡πà‡∏≤', category: 'reptile', src: 'https://img2.pic.in.th/pic/snapedit_1764731213063-Photoroom.png' },
  { id: 'r3', name: '‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ', category: 'reptile', src: 'https://img5.pic.in.th/file/secure-sv1/BeautyPlus-Image-Enhancer-1764731271403-Photoroom.png' },
  { id: 'r4', name: '‡∏Å‡∏¥‡πâ‡∏á‡∏Å‡πà‡∏≤', category: 'reptile', src: 'https://img2.pic.in.th/pic/BeautyPlus-Image-Enhancer-1764731288459-Photoroom.png' },
  // ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡∏µ‡∏Å
  { id: 'wi1', name: '‡πÑ‡∏Å‡πà', category: 'winged', src: 'https://img5.pic.in.th/file/secure-sv1/upscalemedia-transformed-2ead81fa8123cba6e.png' },
  { id: 'wi2', name: '‡∏ô‡∏Å', category: 'winged', src: 'https://img2.pic.in.th/pic/upscalemedia-transformed-18f37512dcb643091.png' },
  { id: 'wi3', name: '‡πÄ‡∏õ‡πá‡∏î', category: 'winged', src: 'https://img5.pic.in.th/file/secure-sv1/upscalemedia-transformed-36d0d1bc7b6103014.png' },
  { id: 'wi4', name: '‡∏ú‡∏µ‡πÄ‡∏™‡∏∑‡πâ‡∏≠', category: 'winged', src: 'https://img2.pic.in.th/pic/upscalemedia-transformed-4.png' },
];

// --- Utilities ---

const shuffle = (array) => {
  return [...array].sort(() => Math.random() - 0.5);
};

// --- Audio System (Synthesizer for BGM) ---

class MusicSynthesizer {
  ctx: AudioContext | null = null;
  isPlaying: boolean = false;
  tempo: number = 180; // BPM
  noteLength: number = 0.25;
  oscillatorType: OscillatorType = 'triangle'; // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏™‡πÜ ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡∏°
  sequence: number = 0;
  timeoutId: any = null;

  constructor() {
    // Init later on user interaction
  }

  init() {
    if (!this.ctx) {
      this.ctx = new (window.AudioContext || (window as any).webkitAudioContext)();
    }
  }

  playNote(freq: number, duration: number, time: number) {
    if (!this.ctx) return;
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    
    osc.type = this.oscillatorType;
    osc.frequency.setValueAtTime(freq, time);
    
    gain.gain.setValueAtTime(0.05, time); // Volume ‡∏ï‡πà‡∏≥‡πÜ ‡πÑ‡∏°‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô
    gain.gain.exponentialRampToValueAtTime(0.001, time + duration - 0.05);

    osc.connect(gain);
    gain.connect(this.ctx.destination);
    
    osc.start(time);
    osc.stop(time + duration);
  }

  start() {
    this.init();
    if (this.isPlaying || !this.ctx) return;
    if (this.ctx.state === 'suspended') this.ctx.resume();
    this.isPlaying = true;
    this.scheduleNextNote();
  }

  stop() {
    this.isPlaying = false;
    clearTimeout(this.timeoutId);
  }

  // ‡∏ó‡∏≥‡∏ô‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏á‡πà‡∏≤‡∏¢‡πÜ (C Major Scale ‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á)
  scheduleNextNote() {
    if (!this.isPlaying || !this.ctx) return;

    const time = this.ctx.currentTime;
    // Melody Pattern
    const melody = [
      523.25, 0, 659.25, 0, 783.99, 0, 1046.50, // C E G C
      783.99, 0, 659.25, 0, 523.25, 0, 0,       // G E C
      587.33, 0, 587.33, 0, 698.46, 0, 880.00, // D D F A
      783.99, 0, 659.25, 0, 523.25, 0, 0        // G E C
    ];

    const freq = melody[this.sequence % melody.length];
    
    if (freq > 0) {
      this.playNote(freq, 0.2, time);
    }

    this.sequence++;
    // Loop
    this.timeoutId = setTimeout(() => this.scheduleNextNote(), (60 / this.tempo) * 1000);
  }
}

const bgmSynth = new MusicSynthesizer();

const playSFX = (type: 'correct' | 'wrong' | 'win' | 'start') => {
  try {
    const audio = new Audio(SOUNDS[type]);
    audio.volume = 0.6;
    audio.play().catch(e => console.log("SFX Blocked", e));
  } catch (e) {
    console.error("Audio Error", e);
  }
};

// --- Main Component ---

export default function CuteAnimalsGame() {
  const [gameState, setGameState] = useState<'start' | 'playing' | 'won'>('start');
  const [animals, setAnimals] = useState([]);
  const [completedCount, setCompletedCount] = useState(0);
  const [feedback, setFeedback] = useState<{ type: 'correct' | 'wrong', msg: string } | null>(null);
  const [draggedItem, setDraggedItem] = useState<any>(null);
  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });
  
  // Audio State
  const [sfxEnabled, setSfxEnabled] = useState(true);
  const [musicEnabled, setMusicEnabled] = useState(false); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏≠‡∏á (Browser Policy)

  const basketsRef = useRef<{ [key: string]: HTMLDivElement | null }>({});
  
  // Effect to manage BGM based on state
  useEffect(() => {
    if (musicEnabled && gameState === 'playing') {
      bgmSynth.start();
    } else {
      bgmSynth.stop();
    }
    return () => bgmSynth.stop();
  }, [musicEnabled, gameState]);

  const toggleMusic = () => {
    setMusicEnabled(!musicEnabled);
  };

  // --- Voice / TTS System ---
  const speakName = useCallback((text: string) => {
    if (!sfxEnabled) return;
    
    // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'th-TH'; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    utterance.rate = 0.8; // ‡∏û‡∏π‡∏î‡∏ä‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πá‡∏Å‡∏ü‡∏±‡∏á‡∏ä‡∏±‡∏î
    
    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const voices = window.speechSynthesis.getVoices();
    const thaiVoice = voices.find(v => v.lang.includes('th'));
    if (thaiVoice) utterance.voice = thaiVoice;

    window.speechSynthesis.speak(utterance);
  }, [sfxEnabled]);

  const startGame = () => {
    setAnimals(shuffle(ANIMALS_DATA).map(a => ({ ...a, completed: false })));
    setCompletedCount(0);
    setGameState('playing');
    setFeedback(null);
    if (sfxEnabled) playSFX('start');
    
    // Auto start music if user already interacted
    if (!musicEnabled) setMusicEnabled(true);

    // Pre-load voices if possible
    window.speechSynthesis.getVoices();
  };

  // --- Drag Handlers ---

  const handlePointerDown = (e: React.PointerEvent, animal: any) => {
    if (animal.completed) return;
    
    // Speak name on touch/click start as well for mobile/tablet feedback
    speakName(animal.name);

    e.preventDefault();
    e.stopPropagation();
    
    const rect = (e.currentTarget as HTMLElement).getBoundingClientRect();
    const offsetX = e.clientX - rect.left;
    const offsetY = e.clientY - rect.top;

    setDraggedItem({ ...animal, offsetX, offsetY });
    setDragPosition({ x: e.clientX, y: e.clientY });
  };

  const handlePointerMove = (e: React.PointerEvent) => {
    if (!draggedItem) return;
    e.preventDefault();
    setDragPosition({ x: e.clientX, y: e.clientY });
  };

  const handlePointerUp = (e: React.PointerEvent) => {
    if (!draggedItem) return;
    e.preventDefault();
    
    const dropX = e.clientX;
    const dropY = e.clientY;
    
    let droppedCategory = null;

    Object.keys(basketsRef.current).forEach(key => {
      const basket = basketsRef.current[key];
      if (basket) {
        const rect = basket.getBoundingClientRect();
        if (dropX >= rect.left && dropX <= rect.right && dropY >= rect.top && dropY <= rect.bottom) {
          droppedCategory = key;
        }
      }
    });

    if (droppedCategory) {
      if (droppedCategory === draggedItem.category) {
        handleCorrectDrop(draggedItem.id);
      } else {
        handleWrongDrop();
      }
    }

    setDraggedItem(null);
  };

  const handleCorrectDrop = (id: string) => {
    if (sfxEnabled) playSFX('win');
    speakName('‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡πÜ‡πÜ');
    setFeedback({ type: 'correct', msg: '‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡πÜ‡πÜ' });
    
    setAnimals(prev => prev.map(a => {
      if (a.id === id) return { ...a, completed: true };
      return a;
    }));
    
    setCompletedCount(prev => {
      const newCount = prev + 1;
      if (newCount === ANIMALS_DATA.length) {
        setTimeout(() => {
            setGameState('won');
            if(sfxEnabled) playSFX('win');
        }, 1000);
      }
      return newCount;
    });

    setTimeout(() => setFeedback(null), 1500);
  };

  const handleWrongDrop = () => {
    if (sfxEnabled) playSFX('wrong');
    setFeedback({ type: 'wrong', msg: '‡∏≠‡∏∏‡πä‡∏¢! ‡∏ú‡∏¥‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏∞ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞' });
    setTimeout(() => setFeedback(null), 1500);
  };

  // --- Renders ---
  
  useEffect(() => {
    const link = document.createElement('link');
    link.href = 'https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap';
    link.rel = 'stylesheet';
    document.head.appendChild(link);
    return () => {
        document.head.removeChild(link);
    };
  }, []);

  if (gameState === 'start') {
    return (
      <div className="relative w-full h-screen bg-cover bg-center overflow-hidden flex flex-col items-center justify-center font-sarabun">
        <div 
            className="absolute inset-0 z-0"
            style={{ 
                backgroundImage: `url('https://img2.pic.in.th/pic/Gemini_Generated_Image_dt996idt996idt99.png')`,
                backgroundSize: 'cover',
                backgroundPosition: 'center',
                filter: 'brightness(0.9)'
            }}
        />
        <div className="relative z-10 flex flex-col items-center animate-fade-in text-center p-4">
          <img 
            src="https://img2.pic.in.th/pic/Gemini_Generated_Image_r6w4wzr6w4wzr6w4-Photoroom.png" 
            alt="‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÇ‡∏•‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏±‡∏Å" 
            className="max-w-[90%] w-[500px] mb-8 drop-shadow-2xl animate-bounce-slow"
          />
          <button 
            onClick={startGame}
            className="group relative bg-yellow-400 hover:bg-yellow-300 text-yellow-900 font-black text-3xl md:text-5xl py-6 px-12 rounded-full border-b-8 border-yellow-600 active:border-b-0 active:translate-y-2 transition-all shadow-[0_10px_20px_rgba(0,0,0,0.3)] transform hover:scale-105"
          >
            <span className="flex items-center gap-3">
               <span className="animate-spin-slow text-4xl">üåü</span> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° <span className="animate-spin-slow text-4xl">üåü</span>
            </span>
          </button>
        </div>
      </div>
    );
  }

  if (gameState === 'won') {
    return (
        <div className="w-full h-screen bg-gradient-to-b from-blue-300 to-purple-400 flex flex-col items-center justify-center p-4 relative overflow-hidden font-sarabun">
            {[...Array(20)].map((_, i) => (
                <div key={i} className="absolute animate-fall" style={{
                    left: `${Math.random() * 100}%`,
                    top: `-10%`,
                    animationDuration: `${Math.random() * 3 + 2}s`,
                    animationDelay: `${Math.random() * 2}s`,
                    fontSize: `${Math.random() * 20 + 20}px`
                }}>
                    {['üéâ', '‚≠ê', 'üéà', 'ü¶Å'][Math.floor(Math.random() * 4)]}
                </div>
            ))}
            <div className="bg-white/90 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-center max-w-lg w-full z-10 border-4 border-yellow-400">
                <Trophy className="w-24 h-24 text-yellow-500 mx-auto mb-4 animate-bounce" />
                <h2 className="text-4xl md:text-5xl font-black text-purple-600 mb-4">‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢!</h2>
                <div className="flex justify-center mb-6">
                    <span className="text-6xl animate-bounce">üêò</span>
                    <span className="text-6xl animate-bounce delay-100">ü¶ã</span>
                    <span className="text-6xl animate-bounce delay-200">üêü</span>
                </div>
                <button 
                    onClick={startGame}
                    className="flex items-center justify-center gap-2 w-full bg-green-500 hover:bg-green-400 text-white font-bold text-2xl py-4 rounded-xl shadow-lg border-b-4 border-green-700 active:border-b-0 active:translate-y-1 transition-all"
                >
                    <RotateCcw /> ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                </button>
            </div>
        </div>
    );
  }

  const remainingAnimals = animals.filter(a => !a.completed);

  return (
    <div 
        className="w-full h-screen bg-gradient-to-b from-sky-50 to-blue-100 flex flex-col overflow-hidden touch-none select-none font-sarabun"
        onPointerMove={handlePointerMove}
        onPointerUp={handlePointerUp}
        onPointerCancel={handlePointerUp}
    >
      
      {/* Header */}
      <div className="bg-white/90 backdrop-blur-sm p-2 shadow-md flex justify-between items-center z-20">
        <h1 className="text-xl font-black text-blue-600 flex items-center gap-2">
            ü¶Å ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÇ‡∏•‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏±‡∏Å
        </h1>
        <div className="flex gap-2 md:gap-4 items-center">
            <div className="px-3 md:px-4 py-1 bg-yellow-100 rounded-full text-yellow-800 font-bold border-2 border-yellow-400 flex items-center text-sm md:text-base">
                ‚≠ê {completedCount} / 16
            </div>
            
            {/* Audio Controls */}
            <div className="flex gap-1 bg-gray-100 p-1 rounded-full border border-gray-300">
                <button 
                    onClick={toggleMusic} 
                    className={`p-2 rounded-full transition-colors ${musicEnabled ? 'bg-purple-100 text-purple-600' : 'bg-gray-200 text-gray-400'}`}
                    title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡πÄ‡∏û‡∏•‡∏á"
                >
                    {musicEnabled ? <Music2 size={20}/> : <Music size={20}/>}
                </button>
                <div className="w-px bg-gray-300 my-1"></div>
                <button 
                    onClick={() => setSfxEnabled(!sfxEnabled)} 
                    className={`p-2 rounded-full transition-colors ${sfxEnabled ? 'bg-green-100 text-green-600' : 'bg-gray-200 text-gray-400'}`}
                    title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå"
                >
                    {sfxEnabled ? <Volume2 size={20}/> : <VolumeX size={20}/>}
                </button>
            </div>
        </div>
      </div>

      {/* Game Area */}
      <div className="flex-1 flex flex-col relative max-w-6xl mx-auto w-full h-full">
        
        {/* Feedback Overlay */}
        {feedback && (
          <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 pointer-events-none w-full text-center">
            <div className={`
              inline-block px-8 py-4 rounded-3xl shadow-2xl text-3xl font-black animate-bounce-in border-4 mx-4
              ${feedback.type === 'correct' ? 'bg-green-100 text-green-600 border-green-500' : 'bg-red-100 text-red-600 border-red-500'}
            `}>
              {feedback.type === 'correct' ? '‚ú® ' : '‚ùå '} 
              {feedback.msg}
            </div>
          </div>
        )}

        {/* Baskets Area (Top) */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4 p-2 md:p-4 h-1/2 min-h-[40%] bg-transparent">
          {CATEGORIES.map((cat) => (
            <div 
              key={cat.id}
              ref={el => basketsRef.current[cat.id] = el}
              className={`
                relative flex flex-col items-center justify-start pt-2 rounded-2xl border-4 shadow-xl backdrop-blur-sm transition-all overflow-hidden
                ${cat.color} ${cat.borderColor}
              `}
            >
              <div className={`text-lg md:text-2xl font-black drop-shadow-md mb-2 bg-white/50 px-4 py-1 rounded-full ${cat.textColor} flex items-center gap-2`}>
                <span className="text-2xl">{cat.icon}</span> {cat.name}
              </div>
              
              <div className="flex flex-wrap content-start justify-center gap-1 p-2 w-full h-full overflow-hidden">
                {animals.filter(a => a.category === cat.id && a.completed).map((animal) => (
                   <img 
                     key={animal.id}
                     src={animal.src} 
                     alt={animal.name}
                     className="w-10 h-10 md:w-16 md:h-16 object-contain animate-pop-in filter drop-shadow-sm"
                   />
                ))}
              </div>
              <div className="absolute bottom-0 w-full h-4 bg-white/10 rounded-b-lg"></div>
            </div>
          ))}
        </div>

        {/* Animals Area (Bottom) */}
        <div className="flex-1 bg-white/80 backdrop-blur-sm border-t-4 border-blue-200 relative p-4 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)]">
            <div className="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-blue-500 px-8 py-2 rounded-full border-4 border-white text-white font-bold text-lg shadow-lg animate-pulse">
                ‡∏•‡∏≤‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            </div>

            <div className="grid grid-cols-4 md:grid-cols-8 gap-2 md:gap-4 justify-items-center content-center h-full overflow-y-auto pt-6">
                {remainingAnimals.map((animal) => (
                    <div
                        key={animal.id}
                        onPointerDown={(e) => handlePointerDown(e, animal)}
                        onPointerEnter={() => speakName(animal.name)} // ‡πÄ‡∏û‡∏¥‡πà‡∏° event ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ
                        className="cursor-grab active:cursor-grabbing w-16 h-16 md:w-24 md:h-24 p-2 rounded-full bg-white shadow-lg border-4 border-white ring-2 ring-blue-100 hover:scale-110 hover:shadow-2xl hover:ring-blue-400 hover:rotate-6 transition-all touch-none flex items-center justify-center group"
                    >
                         <img 
                            src={animal.src} 
                            alt={animal.name} 
                            className="w-full h-full object-contain pointer-events-none group-hover:animate-wiggle"
                         />
                    </div>
                ))}
                {remainingAnimals.length === 0 && (
                     <div className="col-span-full text-gray-400 flex flex-col items-center animate-pulse font-black mt-8">
                        <Sparkles size={64} className="text-yellow-400" />
                        <span className="mt-4 text-2xl text-blue-400">‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢!</span>
                     </div>
                )}
            </div>
        </div>

        {/* Dragged Item Proxy */}
        {draggedItem && (
          <div 
            className="fixed pointer-events-none z-50 w-24 h-24 md:w-32 md:h-32 drop-shadow-2xl"
            style={{
                left: dragPosition.x,
                top: dragPosition.y,
                transform: `translate(-${draggedItem.offsetX}px, -${draggedItem.offsetY}px) scale(1.2) rotate(-5deg)`,
            }}
          >
            <img 
                src={draggedItem.src} 
                alt={draggedItem.name} 
                className="w-full h-full object-contain animate-bounce-slow"
            />
          </div>
        )}

      </div>

      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap');
        .font-sarabun { font-family: 'Sarabun', sans-serif; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(5%); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pop-in { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes wiggle { 0%, 100% { transform: rotate(-6deg); } 50% { transform: rotate(6deg); } }
        @keyframes fall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        @keyframes bounce-in { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); opacity: 1; } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }
        .animate-bounce-slow { animation: bounce-slow 3s infinite ease-in-out; }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }
        .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-wiggle { animation: wiggle 0.4s ease-in-out infinite; }
        .animate-fall { animation: fall linear forwards; }
        .animate-bounce-in { animation: bounce-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
      `}</style>
    </div>
  );
}
